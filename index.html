<html ng-app="custom-webapp-ui" lang="en" style="background-color: white">

<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <!-- Load the Telegram Library -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!--Load the AngularJS Library-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN"
        crossorigin="anonymous"></script>
    <script>
        var imageFile = ""
        var firstName = ""
        var lastName = ""
        var NID = ""
        var DOB = ""
        var address =""
 
        async function callOCR(){
            const formData = new FormData();
            formData.append('file', imageFile)
            const response = await fetch('https://pcla-biu-ml-services-hc6oexyfvq-as.a.run.app/ocr/nid',
            {
                method: 'POST',
                headers:{'APIAuthKey':'pclasecretapikey'},
                body: formData
            }).then(r=>r.json()).then(data => {
                firstName = data['Code'][2].split("<")[0].replace("<","")
                if (data['Code'][2].split("<")[1].replace("<","") != ""){
                lastName = data['Code'][2].split("<")[1].replace("<","")
                } else {
                    lastName = data['Code'][2].split("<")[2].replace("<","")
                }
                NID = data['NID'].split(' ')[0]
                DOB = data['Code'][1].substring(0,6)
                address = data['Address1'] + ' ' + data['Address2']
                console.log(data)
            
            })
            var y = document.getElementById("loaderSpin");
            y.style.display = "none";
            console.log(firstName)
            console.log(lastName)
            console.log(NID)
            console.log(DOB)
            console.log(address)
            document.getElementById("personalInfo").style.display = "block"
            document.getElementById("fname").value = firstName
            document.getElementById("lname").value = lastName
            document.getElementById("id").value = NID
            document.getElementById("add").value = address
        }

        function showButton() {
            if (imageFile != "") {
                var x = document.getElementById("main");
                x.style.display = "none";
                var y = document.getElementById("loaderSpin");
                y.style.display = "block";
                callOCR()
            } else {
                alert('PLEASE UPLOAD NATIONAL ID OR PASSPORT!')
            }
        }


         function returnBackData() {
            const mainButton = window.Telegram.WebApp.MainButton;
            mainButton.text = "Save Preferences";
            mainButton.enable();
            mainButton.show();
            // and make it send the "foods" object (as JSON string) back to the bot
            mainButton.onClick(function () {
                window.Telegram.WebApp.sendData(JSON.stringify({ test: 'test' }));
            })
            mainButton.close();

        }

        function loadFile(event) {
            var image = document.getElementById('output');
            image.src = URL.createObjectURL(event.target.files[0]);
            imageFile = event.target.files[0]
        };

        function submitForOCR() {
            var x = document.getElementById("main");
            if (x.style.display === "none") {
                x.style.display = "block";
            } else {
                x.style.display = "none";
            }
        }


    </script>
</head>
<style>
    .loader {
        position: absolute;
        border: 12px solid #f3f3f3;
        /* Light grey */
        border-top: 12px solid #3498db;
        /* Blue */
        border-radius: 50%;
        width: 120px;
        height: 120px;
        top: 50%;
        left: 50%;
        margin-left: -50px;
        margin-top: -20px;
        animation: spin 2s linear infinite;
        display: none;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }
</style>

<body>
    <div>
        <div id="main">
            <img style="margin-top: 5%;margin-left: 5%;width: 200;"
            src="https://www.prudential.com.kh/export/sites/prudential-kh/km/.galleries/images/PCLA-logo.png" alt="Prudential Logo">
            <p style="margin-top: 2%;margin-left: 5%;font-size: calc(2.3vw + 2.3vh + 1vmin)">PRUeShop on Telegram</p>
            <p style="margin-top: -2%;margin-left: 5%; font-weight: 200; font-size: calc(1vw + 1vh + 0.2vmin)">By
                Prudential Cambodia Life Assurance PLC</p>
            <br />
            <br />
            <p style="margin-left: 5%; font-weight: 200;font-size: calc(1vw + 1vh + 1vmin)">Upload your National ID or
                Passport</p>
            <br />
            <p style="margin-left: 5%;"><img id="output" width="400" /></p>
            <br />
            <input style="margin-left: 5%;font-size: calc(1.2vw + 1.2vh + 0.8vmin)" type="file" accept="image/*"
                id="image_uploads" name="image_uploads" onchange="loadFile(event)">
            <br />
            <Button onclick="showButton()" style="margin-top: calc(1vw + 1vh + 6vmin);margin-left: 20%;font-size:calc(1.2vw + 1.2vh + 0.8vmin); width: 60%;
     margin-bottom: calc(1vw + 1vh + 3vmin);
     ">Next</Button>
        </div>
        <div class="loader" id="loaderSpin"></div>
        <div id="personalInfo" style="display: none;">
            <img style="margin-top: 5%;margin-left: 5%;width: 200;"
            src="https://www.prudential.com.kh/export/sites/prudential-kh/km/.galleries/images/PCLA-logo.png" alt="Prudential Logo">
            <p style="margin-top: 2%;margin-left: 5%;font-size: calc(2.3vw + 2.3vh + 1vmin)">PRUeShop on Telegram</p>
            <p style="margin-top: -2%;margin-left: 5%; font-weight: 200; font-size: calc(1vw + 1vh + 0.2vmin)">By
                Prudential Cambodia Life Assurance PLC</p>
            <br />
            <p style="margin-left: 5%; font-weight: 200;font-size: calc(1vw + 1vh + 1vmin)">Your Personal Information:</p>
            <br />
            <form style="margin-left: 5%">
                <label for="fname">First name:</label>
                <input type="text" id="fname" name="fname" style="width: 65%;"><br><br>
                <label for="lname">Last name:</label>
                <input type="text" id="lname" name="lname"  style="width: 65%;"><br><br>
                <label for="lname">Identification No:</label>
                <input type="text" id="id" name="id"  style="width: 65%;"><br><br>
                <label for="lname">Address:</label>
                <input type="text" id="add" name="add"  style="width: 65%;"><br><br>
            </form>
            
        </div>

    </div>
</body>

</html>